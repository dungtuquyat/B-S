{% extends "home.html" %}

{% block content %}
<div id="rentalManagement" class="content-section p-3 flex-grow-1" style="display:block ;">
    <h4>Qu·∫£n L√Ω Cho Thu√™ </h4>

    <form class="row g-3 align-items-center">
        <!-- √î t√¨m ki·∫øm -->
        <div class="col-md-4 mb-3">
            <input type="text" name="q" class="form-control" placeholder="T√¨m ki·∫øm ph√≤ng..." value="{{ query }}">
        </div>
    
       <!-- Dropdown ch·ªçn tr·∫°ng th√°i -->
        <div class="col-md-4 mb-3">
            <select name="status" class="form-select">
                <option value="">Ch·ªçn tr·∫°ng th√°i</option>
                <option value="available" {% if request.GET.status == "available" %}selected{% endif %}>C√≤n tr·ªëng</option>
                <option value="rented" {% if request.GET.status == "rented" %}selected{% endif %}>ƒê√£ thu√™</option>
            </select>
        </div>

    
        <!-- N√∫t t√¨m ki·∫øm -->
        <div class="col-md-4 mb-3">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i> T√¨m
            </button>
        </div>
    </form>
    {% for apartment in page_obj %}
    <div class="card p-3 mb-3">
        <div class="d-flex align-items-center">
            <!-- ·∫¢nh cƒÉn h·ªô -->
            {% if apartment.image %}
            <img src="{{ apartment.image.url }}" alt="CƒÉn h·ªô" class="img-thumbnail me-3" style="height: 90px; width: 120px;">
        {% endif %}
        
            <!-- Th√¥ng tin cƒÉn h·ªô -->
            <div class="flex-grow-1">
                <h5> {{ apartment.room_name }}</h5>
                <p class="text-muted">
                    <small>ID: {{ apartment.id }} | {{ apartment.building.address }}</small><br>
                    T√™n to√†n nh√†: {{ apartment.building.name }}
                </p>
            </div>

            <!-- Gi√° ti·ªÅn -->
            <div class="text-end me-3">
                <p><strong class="text-success">{{ apartment.price_per_day }}‚Ç´</strong>/ng√†y</p>
                <p><strong class="text-primary">{{ apartment.price_per_month }}‚Ç´</strong>/th√°ng</p>
            </div>

            <!-- Tr·∫°ng th√°i & n√∫t Chi ti·∫øt -->
            <div>
                {% if apartment.available %}
                    <span class="badge bg-success">C√≤n tr·ªëng</span>
                {% else %}
                    <span class="badge bg-danger">ƒê√£ thu√™</span>
                    
                {% endif %}
                {% comment %} <button class="btn btn-outline-secondary">üëÅ Chi ti·∫øt</button> {% endcomment %}
            </div>
            <div class="dropdown">
                <button class="btn btn-link text-dark" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-three-dots-vertical"></i> <!-- Icon d·∫•u ba ch·∫•m -->
                </button>
                <ul class="dropdown-menu">

                    
                    {% if apartment.available %}
                        <!-- C√≤n tr·ªëng: Hi·ªÉn th·ªã n√∫t Th√™m kh√°ch h√†ng -->
                        <li>
                            <a class="dropdown-item text-success add-customer-btn" 
                               href="#" 
                               data-bs-toggle="modal" 
                               data-bs-target="#addCustomerModal"
                               data-apartment-id="{{ apartment.id }}"
                               data-price-per-day="{{ apartment.price_per_day }}"
                               data-price-per-month="{{ apartment.price_per_month }}">
                               <i class="bi bi-person-plus"></i> Th√™m kh√°ch h√†ng
                            </a>
                        </li>
                    {% else %}
                        <!-- ƒê√£ thu√™: Hi·ªÉn th·ªã n√∫t Ch·ªânh s·ª≠a kh√°ch h√†ng -->
                        <li>
                            <a class="dropdown-item text-warning edit-customer-btn" 
                               href="#" 
                               data-bs-toggle="modal" 
                               data-bs-target="#editCustomerModal"
                               data-apartment-id="{{ apartment.id }}">
                               <i class="bi bi-person"></i> Ch·ªânh s·ª≠a kh√°ch h√†ng
                            </a>
                        </li>
                    {% endif %}
            
                    <li>
                        <a class="dropdown-item text-danger delete-btn" 
                        href="#" 
                        data-id="{{ apartment.id }}"
                        data-room_name="{{ apartment.room_name }}"
                        onclick="confirmDeleteCustomer(this)">
                        <i class="bi bi-trash"></i> X√≥a
                     </a>
                     
                    </li>
                </ul>
            </div>
         </div>
    </div>
{% endfor %}

<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1&q={{ request.GET.q }}&building={{ request.GET.building }}">¬´</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ request.GET.q }}&building={{ request.GET.building }}">‚Äπ</a>
            </li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:-2 and num < page_obj.number|add:2 %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}&q={{ request.GET.q }}&building={{ request.GET.building }}">{{ num }}</a>
                </li>
            {% elif num == 1 or num == page_obj.paginator.num_pages %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}&q={{ request.GET.q }}&building={{ request.GET.building }}">{{ num }}</a>
                </li>
            {% elif num == page_obj.number|add:-2 or num == page_obj.number|add:2 %}
                <li class="page-item disabled"><span class="page-link">..</span></li>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ request.GET.q }}&building={{ request.GET.building }}">‚Ä∫</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&q={{ request.GET.q }}&building={{ request.GET.building }}">¬ª</a>
            </li>
        {% endif %}
    </ul>
</nav>
</div>
<!-- Modal Th√™m Kh√°ch H√†ng -->
<div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCustomerLabel">Th√™m kh√°ch h√†ng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCustomerForm">
                    <!-- Ph·∫ßn 1: Th√¥ng tin kh√°ch h√†ng -->
                    <h5>Th√¥ng tin kh√°ch h√†ng</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">H·ªç v√† t√™n</label>
                            <input type="text" class="form-control" name="customer_name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="text" class="form-control" name="phone_number" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">CMND/CCCD</label>
                            <input type="text" class="form-control" name="id_card">
                        </div>
                    </div>

                    <hr>

                    <!-- Ph·∫ßn 2: Th√¥ng tin Booking -->
                    <h5>Th√¥ng tin Booking</h5>
                    <div class="mb-3">
                        <label class="form-label">Lo·∫°i thu√™</label>
                        <select class="form-select" name="booking_type" id="bookingType">
                            <option value="daily">Tr·∫£ theo ng√†y</option>
                            <option value="monthly">Thu√™ theo th√°ng</option>
                        </select>
                    </div>

                    <!-- Booking Section -->
                    <div id="BookingSection">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
                                <input type="date" class="form-control" name="date_check_in" id="dateCheckIn">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ng√†y k·∫øt th√∫c</label>
                                <input type="date" class="form-control" name="date_check_out" id="dateCheckOut">
                            </div>
                            <div class="col-md-12 mt-3">
                                <p><strong>Gi√° thu√™:</strong> <span id="pricePerUnit"></span></p>
                                <p><strong>T·ªïng ti·ªÅn:</strong> <span id="totalPrice"></span></p>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <button type="submit" class="btn btn-primary">L∆∞u kh√°ch h√†ng</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ch·ªânh s·ª≠a kh√°ch h√†ng -->
<div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCustomerModalLabel">Ch·ªânh s·ª≠a kh√°ch h√†ng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCustomerForm">
                    <input type="hidden" name="apartment_id" id="editApartmentId">
                    <input type="hidden" name="customer_id" id="editCustomerId">

                    <!-- Th√¥ng tin kh√°ch h√†ng -->
                    <h5>Th√¥ng tin kh√°ch h√†ng</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">H·ªç v√† t√™n</label>
                            <input type="text" class="form-control" name="customer_name" id="editCustomerName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="text" class="form-control" name="phone_number" id="editPhoneNumber" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="editEmail">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">CMND/CCCD</label>
                            <input type="text" class="form-control" name="id_card" id="editIdCard">
                        </div>
                    </div>

                    <hr>

                    <!-- Th√¥ng tin Booking -->
                    <h5>Th√¥ng tin Booking</h5>
                    <div class="mb-3">
                        <label class="form-label">Lo·∫°i thu√™</label>
                        <select class="form-select" name="booking_type" id="editBookingType">
                            <option value="daily">Tr·∫£ theo ng√†y</option>
                            <option value="monthly">Thu√™ theo th√°ng</option>
                        </select>
                    </div>

                    <div id="editBookingSection">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
                                <input type="date" class="form-control" name="date_check_in" id="editDateCheckIn">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ng√†y k·∫øt th√∫c</label>
                                <input type="date" class="form-control" name="date_check_out" id="editDateCheckOut">
                            </div>
                            <div class="col-md-12 mt-3">
                                <p><strong>Gi√° thu√™:</strong> <span id="editPricePerUnit"></span></p>
                                <p><strong>T·ªïng ti·ªÅn:</strong> <span id="editTotalPrice"></span></p>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
                    <button type="button" class="btn btn-danger" id="cancelCustomerBtn">Hu·ª∑ kh√°ch h√†ng</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const bookingType = document.getElementById("bookingType");
        const dateCheckIn = document.getElementById("dateCheckIn");
        const dateCheckOut = document.getElementById("dateCheckOut");
        const totalPrice = document.getElementById("totalPrice");
        const pricePerUnit = document.getElementById("pricePerUnit");
        const addCustomerModal = document.getElementById("addCustomerModal");
    
        let pricePerDay = 0;
        let pricePerMonth = 0;
    
        // C·∫≠p nh·∫≠t gi√° thu√™ t·ª´ data-* attributes khi m·ªü modal
        addCustomerModal.addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget; // N√∫t m·ªü modal
            pricePerDay = parseFloat(button.getAttribute("data-price-per-day")) || 0;
            pricePerMonth = parseFloat(button.getAttribute("data-price-per-month")) || 0;
    
            updatePriceDisplay(); // C·∫≠p nh·∫≠t gi√° ngay khi m·ªü modal
            calculateTotalPrice(); // Reset t·ªïng ti·ªÅn v·ªÅ 0‚Ç´
        });
    
        // C·∫≠p nh·∫≠t gi√° thu√™ theo ng√†y ho·∫∑c th√°ng
        function updatePriceDisplay() {
            if (bookingType.value === "daily") {
                pricePerUnit.textContent = `${pricePerDay.toLocaleString()}‚Ç´ / ng√†y`;
            } else {
                pricePerUnit.textContent = `${pricePerMonth.toLocaleString()}‚Ç´ / th√°ng`;
            }
        }
    
        // T√≠nh t·ªïng ti·ªÅn thu√™
        function calculateTotalPrice() {
            const checkInDate = new Date(dateCheckIn.value);
            const checkOutDate = new Date(dateCheckOut.value);
    
            if (bookingType.value === "daily" && checkInDate && checkOutDate && checkOutDate > checkInDate) {
                const days = (checkOutDate - checkInDate) / (1000 * 60 * 60 * 24);
                totalPrice.textContent = `${(days * pricePerDay).toLocaleString()}‚Ç´`;
            } else if (bookingType.value === "monthly") {
                totalPrice.textContent = `${pricePerMonth.toLocaleString()}‚Ç´`;
            } else {
                totalPrice.textContent = "0‚Ç´";
            }
        }
    
        // S·ª± ki·ªán thay ƒë·ªïi lo·∫°i thu√™
        bookingType.addEventListener("change", () => {
            updatePriceDisplay();
            calculateTotalPrice();
        });
    
        // S·ª± ki·ªán thay ƒë·ªïi ng√†y ƒë·ªÉ t√≠nh t·ªïng ti·ªÅn
        dateCheckIn.addEventListener("change", calculateTotalPrice);
        dateCheckOut.addEventListener("change", calculateTotalPrice);
    });
    
    document.querySelectorAll(".add-customer-btn").forEach(button => {
        button.addEventListener("click", function() {
            selectedApartmentId = this.getAttribute("data-apartment-id"); // L∆∞u ID c·ªßa cƒÉn h·ªô ƒë∆∞·ª£c nh·∫•n
            console.log("Gi√° tr·ªã c·ªßa data-apartment-id khi nh·∫•n:", selectedApartmentId);
        });
    });
    

    document.getElementById("addCustomerForm").addEventListener("submit", function (event) {
        event.preventDefault();  // NgƒÉn form reload trang
    
        let formData = new FormData(this);
    
    // D√πng gi√° tr·ªã ƒë√£ l∆∞u thay v√¨ l·∫•y t·ª´ n√∫t ƒë·∫ßu ti√™n
        console.log("Gi√° tr·ªã c·ªßa data-apartment-id khi submit:", selectedApartmentId);
    
        if (selectedApartmentId) {
        formData.append("apartment_id", selectedApartmentId);
        }
    
        fetch("/create_booking/", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": "{{ csrf_token }}" // L·∫•y CSRF token t·ª´ cookie
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("ƒê√£ th√™m kh√°ch h√†ng v√† ƒë·∫∑t ph√≤ng th√†nh c√¥ng!");
                location.reload();  // Reload trang sau khi t·∫°o th√†nh c√¥ng
            } else {
                alert("C√≥ l·ªói x·∫£y ra: " + data.error);
            }
        })
        .catch(error => console.error("L·ªói:", error));
    });
    
    document.querySelectorAll(".edit-customer-btn").forEach(button => {
        button.addEventListener("click", function () {
            let apartmentId = this.getAttribute("data-apartment-id");
    
            // G·ªçi API l·∫•y th√¥ng tin kh√°ch h√†ng t·ª´ Django
            fetch(`/get_customer_by_apartment/${apartmentId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let customer = data.customer;
                        let booking = data.booking;
    
                        // ƒêi·ªÅn th√¥ng tin kh√°ch h√†ng v√†o form
                        document.getElementById("editApartmentId").value = apartmentId;
                        document.getElementById("editCustomerId").value = customer.id;
                        document.getElementById("editCustomerName").value = customer.full_name;
                        document.getElementById("editPhoneNumber").value = customer.phone;
                        document.getElementById("editEmail").value = customer.email;
                        document.getElementById("editIdCard").value = customer.cccd;
    
                        // ƒêi·ªÅn th√¥ng tin booking
                        document.getElementById("editBookingType").value = booking.type;
                        document.getElementById("editDateCheckIn").value = booking.date_check_in;
                        document.getElementById("editDateCheckOut").value = booking.date_check_out;
    
                        let pricePerDay = parseFloat(data.price_per_day);
                        let pricePerMonth = parseFloat(data.price_per_month);
    
                        if (booking.type === "daily") {
                            document.getElementById("editPricePerUnit").textContent = pricePerDay.toLocaleString() + "‚Ç´ / ng√†y";
                            let days = (new Date(booking.date_check_out) - new Date(booking.date_check_in)) / (1000 * 60 * 60 * 24);
                            document.getElementById("editTotalPrice").textContent = (days * pricePerDay).toLocaleString() + "‚Ç´";
                        } else {
                            document.getElementById("editPricePerUnit").textContent = pricePerMonth.toLocaleString() + "‚Ç´ / th√°ng";
                            document.getElementById("editTotalPrice").textContent = (pricePerMonth).toLocaleString() + "‚Ç´";
                        }
                    } else {
                        alert("Kh√¥ng t√¨m th·∫•y th√¥ng tin kh√°ch h√†ng!");
                    }
                })
                .catch(error => console.error("L·ªói:", error));
        });
    });

    document.getElementById("editCustomerForm").addEventListener("submit", function (event) {
        event.preventDefault();
    
        let formData = new FormData(this);
    
        fetch("/update_customer/", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                location.reload();
            } else {
                alert("L·ªói: " + data.error);
            }
        })
        .catch(error => console.error("L·ªói:", error));
    });
    
    function confirmDelete(element) {
        let apartmentId = element.getAttribute("data-id");
        let roomName = element.getAttribute("data-room_name");
    
        let message = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a cƒÉn h·ªô "${roomName}" kh√¥ng?\n\n‚ö†Ô∏è L∆∞u √Ω: T·∫•t c·∫£ Booking li√™n quan c≈©ng s·∫Ω b·ªã x√≥a!`;
    
        if (confirm(message)) {
            // N·∫øu ng∆∞·ªùi d√πng ƒë·ªìng √Ω, g·ª≠i request x√≥a
            deleteApartment(apartmentId);
        }
    }
    
    {% comment %} function deleteApartment(apartmentId) {
        fetch(`/delete-apartment/${apartmentId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
        .then(response => {
            if (response.ok) {
                alert("X√≥a th√†nh c√¥ng!");
                location.reload();  // Load l·∫°i trang sau khi x√≥a
            } else {
                alert("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!");
            }
        })
        .catch(error => console.error("L·ªói:", error));
    }
          
     {% endcomment %}
     function confirmDeleteCustomer(element) {
        let apartmentId = element.getAttribute("data-id");
        let roomName = element.getAttribute("data-room_name");
    
        let message = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô kh√°ch h√†ng ƒë√£ t·ª´ng ƒë·∫∑t cƒÉn h·ªô "${roomName}" kh√¥ng?\n\n‚ö†Ô∏è L∆∞u √Ω: T·∫•t c·∫£ Booking c·ªßa kh√°ch h√†ng n√†y c≈©ng s·∫Ω b·ªã x√≥a!`;
    
        if (confirm(message)) {
            deleteCustomer(apartmentId);
        }
    }
    
    function deleteCustomer(apartmentId) {
        fetch(`/delete-customer/${apartmentId}/`, {
            method: "POST",
            headers: {
                 "X-CSRFToken": "{{ csrf_token }}",
                 "Content-Type": "application/json"
            }
        })
        .then(response => {
            if (response.ok) {
                alert("X√≥a kh√°ch h√†ng th√†nh c√¥ng!");
                location.reload();
            } else {
                alert("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!");
            }
        })
        .catch(error => console.error("L·ªói:", error));
    }
    
  
    
</script>



{% endblock %}